{% extends "base.html" %}

{% block title %}Dashboard - Bike Shop ERP{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
            <span class="stat-value">R$ {{ total_vendas|floatformat:2 }}</span>
            <span class="stat-label">Total em Vendas</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">üõí</div>
        <div class="stat-content">
            <span class="stat-value">{{ vendas_hoje }}</span>
            <span class="stat-label">Vendas Finalizadas</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">üì¶</div>
        <div class="stat-content">
            <span class="stat-value">{{ produtos_ativos }}</span>
            <span class="stat-label">Produtos Ativos</span>
        </div>
    </div>

    <div class="stat-card accent">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-content">
            <span class="stat-value">{{ produtos_baixo_estoque }}</span>
            <span class="stat-label">Baixo Estoque</span>
        </div>
    </div>
</div>

<!-- Content Grid -->
<div class="dashboard-grid">
    <!-- Gr√°fico de Vendas -->
    <div class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
            <h3>üìà Desempenho de Vendas (Mensal)</h3>
            <div class="header-actions">
                <span class="badge">√öltimos 6 Meses</span>
            </div>
        </div>
        <div class="card-body" style="height: 350px;">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <!-- √öltimas Vendas -->
    <div class="card">
        <div class="card-header">
            <h3>√öltimas Vendas</h3>
            <a href="{% url 'sales:pdv' %}" class="btn btn-sm">Ver Todas</a>
        </div>
        <div class="card-body">
            {% if ultimas_vendas %}
            <table class="table">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Cliente</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for venda in ultimas_vendas %}
                    <tr>
                        <td><code>{{ venda.id|truncatechars:8 }}</code></td>
                        <td>{{ venda.client.name|default:"‚Äî" }}</td>
                        <td class="text-right">R$ {{ venda.total_amount|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="empty-state">Nenhuma venda registrada.</p>
            {% endif %}
        </div>
    </div>

    <!-- Alertas de Estoque -->
    <div class="card">
        <div class="card-header">
            <h3>‚ö†Ô∏è Alertas de Estoque</h3>
            <a href="{% url 'stock:stock_list' %}?low_stock=1" class="btn btn-sm">Ver Todos</a>
        </div>
        <div class="card-body">
            {% if alertas_estoque %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Dep√≥sito</th>
                        <th>Qtd</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in alertas_estoque %}
                    <tr class="{% if item.quantity < 5 %}danger{% endif %}">
                        <td>{{ item.product.name }}</td>
                        <td>{{ item.warehouse.name }}</td>
                        <td class="text-center"><span class="badge badge-danger">{{ item.quantity }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="empty-state success">‚úÖ Estoque em dia!</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('salesChart').getContext('2d');

        // Gradiente para a linha
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(102, 126, 234, 0.5)');
        gradient.addColorStop(1, 'rgba(118, 75, 162, 0.0)');

        const salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_labels| safe }},
        datasets: [{
            label: 'Vendas (R$)',
            data: {{ chart_data| safe }},
        borderColor: '#667eea',
        borderWidth: 3,
        backgroundColor: gradient,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#ffffff',
        pointBorderColor: '#667eea',
        pointBorderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6
                }]
            },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(10, 10, 26, 0.9)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: 'rgba(255, 255, 255, 0.1)',
                borderWidth: 1,
                padding: 12,
                displayColors: false,
                callbacks: {
                    label: function (context) {
                        return 'R$ ' + context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(255, 255, 255, 0.05)',
                    drawBorder: false
                },
                ticks: {
                    color: 'rgba(255, 255, 255, 0.5)',
                    font: { size: 11 },
                    callback: function (value) {
                        return 'R$ ' + value.toLocaleString('pt-BR');
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: 'rgba(255, 255, 255, 0.5)',
                    font: { size: 11 }
                }
            }
        }
    }
        });
    });
</script>
{% endblock %}